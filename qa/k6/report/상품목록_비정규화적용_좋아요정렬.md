# 상품 목록 비정규화 적용 좋아요 정렬 ( product_summary 좋아요 개수 집계 테이블  )

## 인덱스 적용하기 전

- insert-like-summary.sh  실행 -> generate-like-summary.js 로  데이터 삽입
- k6 run product-list-denormalized.js


### 쿼리

```sql
EXPLAIN
SELECT
    p.id,
    p.price,
    p.name,
    b.name AS brandName,
    COALESCE(s.like_count, 0) AS likeCount,
    p.released_at
FROM
    product p
LEFT JOIN
    brand b ON p.ref_brand_id = b.id
LEFT JOIN
    like_summary s ON s.target_id = p.id AND s.target_type = 'PRODUCT'
ORDER BY
    s.like_count DESC
LIMIT 5 OFFSET 0;
```


### 쿼리 실행 결과

```sql
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
| id     | price   | name              | brandName                           | likeCount | released_at                |
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
|  16185 | 8736800 | ??? ??? #16185    | Yintech Investment Holdings Limited |        12 | 2025-07-17 00:00:00.000000 |
| 122023 | 2448844 | ???? ???? #122023 | Esterline Technologies Corporation  |        11 | 2024-09-11 00:00:00.000000 |
| 146237 | 4773730 | ??? ?? #146237    | Aerohive Networks, Inc.             |        11 | 2024-09-12 00:00:00.000000 |
|  28878 | 9561636 | ???? ?? #28878    | IZEA Inc.                           |        11 | 2025-05-16 00:00:00.000000 |
| 248568 | 7972070 | ??? ?? #248568    | Enduro Royalty Trust                |        11 | 2025-03-09 00:00:00.000000 |
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
5 rows in set (1.92 sec)

```


### 쿼리 실행 계획

```sql
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
| id | select_type | table | partitions | type   | possible_keys               | key                         | key_len | ref                    | rows   | filtered | Extra                           |
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
|  1 | SIMPLE      | p     | NULL       | ALL    | NULL                        | NULL                        | NULL    | NULL                   | 497349 |   100.00 | Using temporary; Using filesort |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY                     | PRIMARY                     | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                            |
|  1 | SIMPLE      | s     | NULL       | eq_ref | UKaqw1do2xdd90a3o0aneikiq8y | UKaqw1do2xdd90a3o0aneikiq8y | 11      | loopers.p.id,const     |      1 |   100.00 | Using index condition           |
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
3 rows in set, 1 warning (0.01 sec)
```


## 인덱스 적용 후 (like_count 단일 인덱스 )

```sql
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table        | Non_unique | Key_name                    | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| like_summary |          0 | PRIMARY                     |            1 | id          | A         |      430750 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| like_summary |          0 | UKaqw1do2xdd90a3o0aneikiq8y |            1 | target_id   | A         |      430750 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
| like_summary |          0 | UKaqw1do2xdd90a3o0aneikiq8y |            2 | target_type | A         |      430750 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
| like_summary |          1 | idx_like_count              |            1 | like_count  | A         |          11 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
4 rows in set (0.01 sec)
```

### 쿼리

```sql
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
| id     | price   | name              | brandName                           | likeCount | released_at                |
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
|  16185 | 8736800 | ??? ??? #16185    | Yintech Investment Holdings Limited |        12 | 2025-07-17 00:00:00.000000 |
| 122023 | 2448844 | ???? ???? #122023 | Esterline Technologies Corporation  |        11 | 2024-09-11 00:00:00.000000 |
| 146237 | 4773730 | ??? ?? #146237    | Aerohive Networks, Inc.             |        11 | 2024-09-12 00:00:00.000000 |
|  28878 | 9561636 | ???? ?? #28878    | IZEA Inc.                           |        11 | 2025-05-16 00:00:00.000000 |
| 248568 | 7972070 | ??? ?? #248568    | Enduro Royalty Trust                |        11 | 2025-03-09 00:00:00.000000 |
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
5 rows in set (1.86 sec)
```

### 실행 결과

```sql
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
| id | select_type | table | partitions | type   | possible_keys               | key                         | key_len | ref                    | rows   | filtered | Extra                           |
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
|  1 | SIMPLE      | p     | NULL       | ALL    | NULL                        | NULL                        | NULL    | NULL                   | 497349 |   100.00 | Using temporary; Using filesort |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY                     | PRIMARY                     | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                            |
|  1 | SIMPLE      | s     | NULL       | eq_ref | UKaqw1do2xdd90a3o0aneikiq8y | UKaqw1do2xdd90a3o0aneikiq8y | 11      | loopers.p.id,const     |      1 |   100.00 | Using index condition           |
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
3 rows in set, 1 warning (0.01 sec)
```


## 인덱스 적용 후 (target_type , like_count 복합 인덱스)

```sql
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table        | Non_unique | Key_name                    | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| like_summary |          0 | PRIMARY                     |            1 | id          | A         |      430750 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| like_summary |          0 | UKaqw1do2xdd90a3o0aneikiq8y |            1 | target_id   | A         |      430750 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
| like_summary |          0 | UKaqw1do2xdd90a3o0aneikiq8y |            2 | target_type | A         |      430750 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
| like_summary |          1 | idx_target_type_like_count  |            1 | target_type | A         |           1 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
| like_summary |          1 | idx_target_type_like_count  |            2 | like_count  | A         |          11 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
5 rows in set (0.01 sec)
```


### 쿼리 

```sql
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
| id     | price   | name              | brandName                           | likeCount | released_at                |
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
|  16185 | 8736800 | ??? ??? #16185    | Yintech Investment Holdings Limited |        12 | 2025-07-17 00:00:00.000000 |
| 122023 | 2448844 | ???? ???? #122023 | Esterline Technologies Corporation  |        11 | 2024-09-11 00:00:00.000000 |
| 146237 | 4773730 | ??? ?? #146237    | Aerohive Networks, Inc.             |        11 | 2024-09-12 00:00:00.000000 |
|  28878 | 9561636 | ???? ?? #28878    | IZEA Inc.                           |        11 | 2025-05-16 00:00:00.000000 |
| 248568 | 7972070 | ??? ?? #248568    | Enduro Royalty Trust                |        11 | 2025-03-09 00:00:00.000000 |
+--------+---------+-------------------+-------------------------------------+-----------+----------------------------+
5 rows in set (1.84 sec)

```

### 실행 계획

```sql
-------------------+
| id | select_type | table | partitions | type   | possible_keys                                          | key                         | key_len | ref                    | rows   | filtered | Extra                           |
+----+-------------+-------+------------+--------+--------------------------------------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
|  1 | SIMPLE      | p     | NULL       | ALL    | NULL                                                   | NULL                        | NULL    | NULL                   | 497349 |   100.00 | Using temporary; Using filesort |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY                                                | PRIMARY                     | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                            |
|  1 | SIMPLE      | s     | NULL       | eq_ref | UKaqw1do2xdd90a3o0aneikiq8y,idx_target_type_like_count | UKaqw1do2xdd90a3o0aneikiq8y | 11      | loopers.p.id,const     |      1 |   100.00 | Using index condition           |
+----+-------------+-------+------------+--------+--------------------------------------------------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------+
3 rows in set, 1 warning (0.03 sec)
```


### 브랜드 ID  


```sql
SELECT
    p.id,
    p.price,
    p.name,
    b.name AS brandName,
    COALESCE(s.like_count, 0) AS likeCount,
    p.released_at
FROM
    product p
LEFT JOIN
    brand b ON p.brand_id = b.id
LEFT JOIN
    like_summary s ON s.target_id = p.id AND s.target_type = 'PRODUCT'
WHERE
    b.id = 123
ORDER BY
    p.released_at DESC
LIMIT 5 OFFSET 0;
```


