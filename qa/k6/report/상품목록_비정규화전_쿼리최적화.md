# 상품 목록 비정규화 하기 전 쿼리 최적화  ( product_like 좋아요 개수 서브쿼리로  )

## 인덱스 적용하기 전

- insert-all-data.sh  실행 -> generate-all-data.js 로  상품 데이터 50만개 생성
- k6 run product-list-optimized.js


###  쿼리


```sql
EXPLAIN
SELECT
    p.id,
    p.price,
    p.name,
    b.name,
    (SELECT count(*) FROM product_like pl WHERE pl.ref_product_id = p.id) as likeCount,
    p.released_at
FROM
    product p
        LEFT JOIN
    brand b ON b.id = p.ref_brand_id
ORDER BY
    p.price ASC  
    LIMIT 5 OFFSET 0;
```

### k6 실행 결과


```sql

  █ TOTAL RESULTS 

    checks_total.......................: 224     3.714155/s
    checks_succeeded...................: 100.00% 224 out of 224
    checks_failed......................: 0.00%   0 out of 224

    ✓ status is 200
    ✓ response body has 5 items

    HTTP
    http_req_duration.......................................................: avg=437.43ms min=401.73ms med=418.86ms max=1.88s p(90)=431.28ms p(95)=453.52ms
      { expected_response:true }............................................: avg=437.43ms min=401.73ms med=418.86ms max=1.88s p(90)=431.28ms p(95)=453.52ms
    http_req_failed.........................................................: 0.00%  0 out of 112
    http_reqs...............................................................: 112    1.857077/s

    EXECUTION
    iteration_duration......................................................: avg=538.39ms min=502.01ms med=519.83ms max=1.99s p(90)=532.09ms p(95)=554.08ms
    iterations..............................................................: 112    1.857077/s
    vus.....................................................................: 1      min=1        max=1
    vus_max.................................................................: 1      min=1        max=1

    NETWORK
    data_received...........................................................: 116 kB 1.9 kB/s
    data_sent...............................................................: 15 kB  243 B/s



```

### 쿼리 실행 결과 

```sql
+--------+-------+-------------------+-------------------------+-----------+----------------------------+
| id     | price | name              | name                    | likeCount | released_at                |
+--------+-------+-------------------+-------------------------+-----------+----------------------------+
|  12371 |  1032 | ???? ?? #12371    | Synovus Financial Corp. |         0 | 2024-10-07 00:00:00.000000 |
| 293710 |  1046 | ????? ??? #293710 | ViewRay, Inc.           |         1 | 2024-10-02 00:00:00.000000 |
|  92079 |  1084 | ????? ?? #92079   | Dermira, Inc.           |         0 | 2025-06-04 00:00:00.000000 |
| 318171 |  1101 | ??? ??? #318171   | Sussex Bancorp          |         0 | 2024-12-13 00:00:00.000000 |
| 251337 |  1139 | ????? ?? #251337  | CSI Compressco LP       |         0 | 2025-02-23 00:00:00.000000 |
+--------+-------+-------------------+-------------------------+-----------+----------------------------+
5 rows in set (0.63 sec)

```


### 쿼리 실행 계획

```sql
+----+--------------------+-------+------------+--------+---------------+-----------------------------+---------+------------------------+--------+----------+--------------------------+
| id | select_type        | table | partitions | type   | possible_keys | key                         | key_len | ref                    | rows   | filtered | Extra                    |
+----+--------------------+-------+------------+--------+---------------+-----------------------------+---------+------------------------+--------+----------+--------------------------+
|  1 | PRIMARY            | p     | NULL       | ALL    | NULL          | NULL                        | NULL    | NULL                   | 497193 |   100.00 | Using filesort           |
|  1 | PRIMARY            | b     | NULL       | eq_ref | PRIMARY       | PRIMARY                     | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                     |
|  2 | DEPENDENT SUBQUERY | pl    | NULL       | index  | NULL          | UKi88ydvxuyj9djsf1yaq18mdpb | 16      | NULL                   |  99822 |    10.00 | Using where; Using index |
+----+--------------------+-------+------------+--------+---------------+-----------------------------+---------+------------------------+--------+----------+--------------------------+
3 rows in set, 2 warnings (0.02 sec)
```




## 인덱스 적용 후 ( product 에 price 인덱스 추가 , product_like 에 ref_product_id 인덱스 추가 )


### k6 실행 결과

```sql


  █ TOTAL RESULTS 

    checks_total.......................: 508     8.441276/s
    checks_succeeded...................: 100.00% 508 out of 508
    checks_failed......................: 0.00%   0 out of 508

    ✓ status is 200
    ✓ response body has 5 items

    HTTP
    http_req_duration.......................................................: avg=135.85ms min=86.85ms  med=102.94ms max=3.68s p(90)=184.37ms p(95)=227.42ms
      { expected_response:true }............................................: avg=135.85ms min=86.85ms  med=102.94ms max=3.68s p(90)=184.37ms p(95)=227.42ms
    http_req_failed.........................................................: 0.00%  0 out of 254
    http_reqs...............................................................: 254    4.220638/s

    EXECUTION
    iteration_duration......................................................: avg=236.86ms min=187.24ms med=203.78ms max=3.79s p(90)=285.82ms p(95)=328.86ms
    iterations..............................................................: 254    4.220638/s
    vus.....................................................................: 1      min=1        max=1
    vus_max.................................................................: 1      min=1        max=1

    NETWORK
    data_received...........................................................: 269 kB 4.5 kB/s
    data_sent...............................................................: 33 kB  553 B/s



```


### 쿼리 실행 결과



```sql

+--------+-------+------------------+-----------------------------------+-----------+----------------------------+
| id     | price | name             | name                              | likeCount | released_at                |
+--------+-------+------------------+-----------------------------------+-----------+----------------------------+
| 177244 |  1003 | ??? ?? #177244   | Campbell Soup Company             |         0 | 2025-01-02 00:00:00.000000 |
| 212235 |  1012 | ????? ?? #212235 | Pinnacle West Capital Corporation |         0 | 2025-01-26 00:00:00.000000 |
| 361729 |  1013 | ??? ??? #361729  | Sanchez Energy Corporation        |         1 | 2024-12-31 00:00:00.000000 |
| 404363 |  1041 | ??? ?? #404363   | Benitec Biopharma Limited         |         0 | 2025-06-21 00:00:00.000000 |
| 272216 |  1055 | ??? ??? #272216  | The GDL Fund                      |         0 | 2024-11-16 00:00:00.000000 |
+--------+-------+------------------+-----------------------------------+-----------+----------------------------+
5 rows in set (0.01 sec)


```


### 쿼리 실행 계획



```sql
+----+--------------------+-------+------------+--------+------------------------------+------------------------------+---------+------------------------+------+----------+-------------+
| id | select_type        | table | partitions | type   | possible_keys                | key                          | key_len | ref                    | rows | filtered | Extra       |
+----+--------------------+-------+------------+--------+------------------------------+------------------------------+---------+------------------------+------+----------+-------------+
|  1 | PRIMARY            | p     | NULL       | index  | NULL                         | IDXtbckthfcaxou9w0aaflyab283 | 9       | NULL                   |    5 |   100.00 | NULL        |
|  1 | PRIMARY            | b     | NULL       | eq_ref | PRIMARY                      | PRIMARY                      | 8       | loopers.p.ref_brand_id |    1 |   100.00 | NULL        |
|  2 | DEPENDENT SUBQUERY | pl    | NULL       | ref    | IDXm1pb65po5qwmli6k2owxbabpg | IDXm1pb65po5qwmli6k2owxbabpg | 8       | loopers.p.id           |    1 |   100.00 | Using index |
+----+--------------------+-------+------------+--------+------------------------------+------------------------------+---------+------------------------+------+----------+-------------+
```
