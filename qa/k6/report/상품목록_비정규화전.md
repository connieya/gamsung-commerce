_# 상품 목록 비정규화 하기 전 ( product_like 와 join 후 group by )

## 인덱스 적용하기 전

- insert-all-data.sh  실행 -> generate-all-data.js 로  상품 데이터 50만개 생성
- k6 run product-list.js

### 쿼리


```sql
EXPLAIN
SELECT
    p.id
     ,p.price
     ,p.name
     ,b.name
     , count(pl.id) as likeCount
     , p.released_at FROM
    product p
        LEFT JOIN brand b ON b.id = p.ref_brand_id
        LEFT JOIN  product_like pl ON p.id = pl.ref_product_id
GROUP BY
    p.id
       , p.price
       ,p.name
       , b.name
       , p.released_at
ORDER BY p.price ASC
    LIMIT 5 OFFSET 0;
```


### k6 실행 결과

```sql
  █ TOTAL RESULTS 

    checks_total.......................: 12      0.173676/s
    checks_succeeded...................: 100.00% 12 out of 12
    checks_failed......................: 0.00%   0 out of 12

    ✓ status is 200
    ✓ response body has 5 items

    HTTP
    http_req_duration.......................................................: avg=11.41s min=9.71s med=10.86s max=15.36s p(90)=13.39s p(95)=14.37s
      { expected_response:true }............................................: avg=11.41s min=9.71s med=10.86s max=15.36s p(90)=13.39s p(95)=14.37s
    http_req_failed.........................................................: 0.00%  0 out of 6
    http_reqs...............................................................: 6      0.086838/s

    EXECUTION
    iteration_duration......................................................: avg=11.51s min=9.82s med=10.97s max=15.47s p(90)=13.49s p(95)=14.48s
    iterations..............................................................: 6      0.086838/s
    vus.....................................................................: 1      min=1      max=1
    vus_max.................................................................: 1      min=1      max=1

    NETWORK
    data_received...........................................................: 6.3 kB 91 B/s
    data_sent...............................................................: 726 B  11 B/s
```

### 쿼리 실행 결과 


```sql
+--------+-------+-------------------+-------------------------+-----------+----------------------------+
| id     | price | name              | name                    | likeCount | released_at                |
+--------+-------+-------------------+-------------------------+-----------+----------------------------+
|  12371 |  1032 | ???? ?? #12371    | Synovus Financial Corp. |         0 | 2024-10-07 00:00:00.000000 |
| 293710 |  1046 | ????? ??? #293710 | ViewRay, Inc.           |         1 | 2024-10-02 00:00:00.000000 |
|  92079 |  1084 | ????? ?? #92079   | Dermira, Inc.           |         0 | 2025-06-04 00:00:00.000000 |
| 318171 |  1101 | ??? ??? #318171   | Sussex Bancorp          |         0 | 2024-12-13 00:00:00.000000 |
| 251337 |  1139 | ????? ?? #251337  | CSI Compressco LP       |         0 | 2025-02-23 00:00:00.000000 |
+--------+-------+-------------------+-------------------------+-----------+----------------------------+
5 rows in set (6.75 sec)


```

### 쿼리 실행 계획

```sql
+----+-------------+-------+------------+--------+---------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys | key                         | key_len | ref                    | rows   | filtered | Extra                                                   |
+----+-------------+-------+------------+--------+---------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------------------------------+
|  1 | SIMPLE      | p     | NULL       | ALL    | NULL          | NULL                        | NULL    | NULL                   | 497193 |   100.00 | Using temporary; Using filesort                         |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY       | PRIMARY                     | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                                                    |
|  1 | SIMPLE      | pl    | NULL       | index  | NULL          | UKi88ydvxuyj9djsf1yaq18mdpb | 16      | NULL                   |  99822 |   100.00 | Using where; Using index; Using join buffer (hash join) |
+----+-------------+-------+------------+--------+---------------+-----------------------------+---------+------------------------+--------+----------+---------------------------------------------------------+
3 rows in set, 1 warning (0.00 sec)
```



## 인덱스 적용 후 ( product 에 price 인덱스 추가 , product_like 에 ref_product_id 인덱스 추가 )

별 차이가 없고 오히려 더 느려진 것 같다.

### k6 실행 결과

```sql

  █ TOTAL RESULTS 

    checks_total.......................: 10      0.149851/s
    checks_succeeded...................: 100.00% 10 out of 10
    checks_failed......................: 0.00%   0 out of 10

    ✓ status is 200
    ✓ response body has 5 items

    HTTP
    http_req_duration.......................................................: avg=13.24s min=10.46s med=11.6s max=18.14s p(90)=17.04s p(95)=17.59s
      { expected_response:true }............................................: avg=13.24s min=10.46s med=11.6s max=18.14s p(90)=17.04s p(95)=17.59s
    http_req_failed.........................................................: 0.00%  0 out of 5
    http_reqs...............................................................: 5      0.074926/s

    EXECUTION
    iteration_duration......................................................: avg=13.34s min=10.56s med=11.7s max=18.26s p(90)=17.15s p(95)=17.7s 
    iterations..............................................................: 5      0.074926/s
    vus.....................................................................: 1      min=1                 max=1
    vus_max.................................................................: 1      min=1                 max=1

    NETWORK
    data_received...........................................................: 5.2 kB 78 B/s
    data_sent...............................................................: 605 B  9.066008695216432 B/s
```

### 쿼리 실행 결과

```sql
+--------+-------+------------------+-----------------------------------+-----------+----------------------------+
| id     | price | name             | name                              | likeCount | released_at                |
+--------+-------+------------------+-----------------------------------+-----------+----------------------------+
| 177244 |  1003 | ??? ?? #177244   | Campbell Soup Company             |         0 | 2025-01-02 00:00:00.000000 |
| 212235 |  1012 | ????? ?? #212235 | Pinnacle West Capital Corporation |         0 | 2025-01-26 00:00:00.000000 |
| 361729 |  1013 | ??? ??? #361729  | Sanchez Energy Corporation        |         1 | 2024-12-31 00:00:00.000000 |
| 404363 |  1041 | ??? ?? #404363   | Benitec Biopharma Limited         |         0 | 2025-06-21 00:00:00.000000 |
| 272216 |  1055 | ??? ??? #272216  | The GDL Fund                      |         0 | 2024-11-16 00:00:00.000000 |
+--------+-------+------------------+-----------------------------------+-----------+----------------------------+
5 rows in set (6.40 sec)
```

### 쿼리 실행 계확


```sql
+----+-------------+-------+------------+--------+------------------------------+------------------------------+---------+------------------------+--------+----------+---------------------------------+
| id | select_type | table | partitions | type   | possible_keys                | key                          | key_len | ref                    | rows   | filtered | Extra                           |
+----+-------------+-------+------------+--------+------------------------------+------------------------------+---------+------------------------+--------+----------+---------------------------------+
|  1 | SIMPLE      | p     | NULL       | ALL    | NULL                         | NULL                         | NULL    | NULL                   | 497349 |   100.00 | Using temporary; Using filesort |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY                      | PRIMARY                      | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                            |
|  1 | SIMPLE      | pl    | NULL       | ref    | IDXm1pb65po5qwmli6k2owxbabpg | IDXm1pb65po5qwmli6k2owxbabpg | 8       | loopers.p.id           |      1 |   100.00 | Using index                     |
+----+-------------+-------+------------+--------+------------------------------+------------------------------+---------+------------------------+--------+----------+---------------------------------+
```
