# 상품 목록 비정규화 적용 가격 정렬 ( product_summary 좋아요 개수 집계 테이블  )

## 인덱스 적용하기 전

- insert-like-summary.sh  실행 -> generate-like-summary.js 로  데이터 삽입
- k6 run product-list-denormalized.js


### 쿼리

```sql
EXPLAIN
SELECT
    p.id,
    p.price,
    p.name,
    b.name AS brandName,
    COALESCE(s.like_count, 0) AS likeCount,
    p.released_at
FROM
    product p
LEFT JOIN
    brand b ON p.ref_brand_id = b.id
LEFT JOIN
    like_summary s ON s.target_id = p.id AND s.target_type = 'PRODUCT'
ORDER BY
    p.price ASC
LIMIT 5 OFFSET 0;
```


### 쿼리 실행 결과

```sql
+--------+-------+-----------------+-------------------------------------+-----------+----------------------------+
| id     | price | name            | brandName                           | likeCount | released_at                |
+--------+-------+-----------------+-------------------------------------+-----------+----------------------------+
| 156788 |  1000 | ??? ??? #156788 | SharpSpring, Inc.                   |         2 | 2025-04-14 00:00:00.000000 |
|  54551 |  1002 | ??? ?? #54551   | Jacobs Engineering Group Inc.       |         1 | 2024-09-09 00:00:00.000000 |
|  43768 |  1013 | ??? ?? #43768   | Boulevard Acquisition Corp. II      |         2 | 2025-07-02 00:00:00.000000 |
| 149791 |  1044 | ??? ??? #149791 | National Storage Affiliates Trust   |         5 | 2024-09-21 00:00:00.000000 |
| 402798 |  1046 | ???? ?? #402798 | American Superconductor Corporation |         0 | 2025-06-17 00:00:00.000000 |
+--------+-------+-----------------+-------------------------------------+-----------+----------------------------+
5 rows in set (0.00 sec)
```


### 쿼리 실행 계획


```sql
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+------+----------+-----------------------+
| id | select_type | table | partitions | type   | possible_keys               | key                         | key_len | ref                    | rows | filtered | Extra                 |
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+------+----------+-----------------------+
|  1 | SIMPLE      | p     | NULL       | index  | NULL                        | idx_price                   | 9       | NULL                   |    5 |   100.00 | NULL                  |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY                     | PRIMARY                     | 8       | loopers.p.ref_brand_id |    1 |   100.00 | NULL                  |
|  1 | SIMPLE      | s     | NULL       | eq_ref | UKaqw1do2xdd90a3o0aneikiq8y | UKaqw1do2xdd90a3o0aneikiq8y | 11      | loopers.p.id,const     |    1 |   100.00 | Using index condition |
+----+-------------+-------+------------+--------+-----------------------------+-----------------------------+---------+------------------------+------+----------+-----------------------+
3 rows in set, 1 warning (0.00 sec)
```


## 인덱스 



like_summary 테이블에는 이미  JPA/Hibernate와 같은 ORM이 자동으로 생성해준 유니크 제약조건(Unique Constraint) 으로 복합 인덱스를 걸어놓았다.

```sql
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table        | Non_unique | Key_name                    | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| like_summary |          0 | PRIMARY                     |            1 | id          | A         |      430750 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| like_summary |          0 | UKaqw1do2xdd90a3o0aneikiq8y |            1 | target_id   | A         |      430750 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
| like_summary |          0 | UKaqw1do2xdd90a3o0aneikiq8y |            2 | target_type | A         |      430750 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
+--------------+------------+-----------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
3 rows in set (0.02 sec)
```





### 브랜드 ID  


```sql
SELECT
    p.id,
    p.price,
    p.name,
    b.name AS brandName,
    COALESCE(s.like_count, 0) AS likeCount,
    p.released_at
FROM
    product p
LEFT JOIN
    brand b ON p.brand_id = b.id
LEFT JOIN
    like_summary s ON s.target_id = p.id AND s.target_type = 'PRODUCT'
WHERE
    b.id = 123
ORDER BY
    p.released_at DESC
LIMIT 5 OFFSET 0;
```


