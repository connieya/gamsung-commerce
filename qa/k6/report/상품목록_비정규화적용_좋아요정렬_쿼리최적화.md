# 상품 목록 비정규화 적용 가격 정렬 쿼리 최적화 ( product_summary 좋아요 개수 집계 테이블  + Like summary 테이블 먼저 읽기 )

## 인덱스 적용

- insert-like-summary.sh  실행 -> generate-like-summary.js 로  데이터 삽입
- k6 run product-list-denormalized.js


### 쿼리

```sql
EXPLAIN
SELECT
    p.id,
    p.price,
    p.name,
    b.name AS brandName,
    s.like_count AS likeCount,
    p.released_at
FROM
    like_summary s
    STRAIGHT_JOIN 
    product p ON s.target_id = p.id
    LEFT JOIN
    brand b ON p.ref_brand_id = b.id
WHERE
    s.target_type = 'PRODUCT'
ORDER BY
    s.like_count DESC
    LIMIT 5 OFFSET 0;
```


### 쿼리 실행 결과

```sql
+--------+---------+-----------------+-------------------------------------+-----------+----------------------------+
| id     | price   | name            | brandName                           | likeCount | released_at                |
+--------+---------+-----------------+-------------------------------------+-----------+----------------------------+
|  16185 | 8736800 | ??? ??? #16185  | Yintech Investment Holdings Limited |        12 | 2025-07-17 00:00:00.000000 |
| 248568 | 7972070 | ??? ?? #248568  | Enduro Royalty Trust                |        11 | 2025-03-09 00:00:00.000000 |
| 355398 | 5106636 | ??? ??? #355398 | NTT DOCOMO, Inc                     |        11 | 2024-11-09 00:00:00.000000 |
| 315397 | 7401660 | ??? ?? #315397  | NV5 Global, Inc.                    |        11 | 2025-07-29 00:00:00.000000 |
| 146237 | 4773730 | ??? ?? #146237  | Aerohive Networks, Inc.             |        11 | 2024-09-12 00:00:00.000000 |
+--------+---------+-----------------+-------------------------------------+-----------+----------------------------+
5 rows in set (0.03 sec)



```


### 쿼리 실행 계획

```sql
+----+-------------+-------+------------+--------+--------------------------------------------------------+----------------------------+---------+------------------------+--------+----------+----------------------------------+
| id | select_type | table | partitions | type   | possible_keys                                          | key                        | key_len | ref                    | rows   | filtered | Extra                            |
+----+-------------+-------+------------+--------+--------------------------------------------------------+----------------------------+---------+------------------------+--------+----------+----------------------------------+
|  1 | SIMPLE      | s     | NULL       | ref    | UKaqw1do2xdd90a3o0aneikiq8y,idx_target_type_like_count | idx_target_type_like_count | 2       | const                  | 215375 |   100.00 | Using where; Backward index scan |
|  1 | SIMPLE      | p     | NULL       | eq_ref | PRIMARY                                                | PRIMARY                    | 8       | loopers.s.target_id    |      1 |   100.00 | NULL                             |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY                                                | PRIMARY                    | 8       | loopers.p.ref_brand_id |      1 |   100.00 | NULL                             |
+----+-------------+-------+------------+--------+--------------------------------------------------------+----------------------------+---------+------------------------+--------+----------+----------------------------------+
3 rows in set, 1 warning (0.01 sec)


```


